<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Fixed Point Arithmetic | Substrate Recipes</title>
    <meta name="generator" content="VuePress 1.5.3">
    
    <meta name="description" content="Substrate Recipes">
    <link rel="preload" href="/assets/css/0.styles.ad025e7c.css" as="style"><link rel="preload" href="/assets/js/app.a10ecbc3.js" as="script"><link rel="preload" href="/assets/js/3.911ff76f.js" as="script"><link rel="preload" href="/assets/js/1.8aeda072.js" as="script"><link rel="preload" href="/assets/js/35.98662951.js" as="script"><link rel="prefetch" href="/assets/js/10.f6e4b8e2.js"><link rel="prefetch" href="/assets/js/100.7dc1ff05.js"><link rel="prefetch" href="/assets/js/101.297542a2.js"><link rel="prefetch" href="/assets/js/102.4a256fa2.js"><link rel="prefetch" href="/assets/js/103.0d6e0535.js"><link rel="prefetch" href="/assets/js/104.8cf46d1e.js"><link rel="prefetch" href="/assets/js/105.63908dc3.js"><link rel="prefetch" href="/assets/js/106.9bb37e6d.js"><link rel="prefetch" href="/assets/js/107.d8653b02.js"><link rel="prefetch" href="/assets/js/108.4d618824.js"><link rel="prefetch" href="/assets/js/109.904cfb03.js"><link rel="prefetch" href="/assets/js/11.81ae87e1.js"><link rel="prefetch" href="/assets/js/110.9246670b.js"><link rel="prefetch" href="/assets/js/111.2a53fdf3.js"><link rel="prefetch" href="/assets/js/112.2377b53a.js"><link rel="prefetch" href="/assets/js/113.c460dd88.js"><link rel="prefetch" href="/assets/js/114.b5d73637.js"><link rel="prefetch" href="/assets/js/115.362b464f.js"><link rel="prefetch" href="/assets/js/116.2f85b476.js"><link rel="prefetch" href="/assets/js/117.76166f7d.js"><link rel="prefetch" href="/assets/js/118.6e1563f6.js"><link rel="prefetch" href="/assets/js/119.57707c67.js"><link rel="prefetch" href="/assets/js/12.4527bb4d.js"><link rel="prefetch" href="/assets/js/120.2395aeb4.js"><link rel="prefetch" href="/assets/js/121.56c41d8d.js"><link rel="prefetch" href="/assets/js/122.fa2cde0f.js"><link rel="prefetch" href="/assets/js/123.7811c41b.js"><link rel="prefetch" href="/assets/js/124.c6bc1d12.js"><link rel="prefetch" href="/assets/js/125.cd517541.js"><link rel="prefetch" href="/assets/js/126.658b224e.js"><link rel="prefetch" href="/assets/js/127.08cca44a.js"><link rel="prefetch" href="/assets/js/128.df264345.js"><link rel="prefetch" href="/assets/js/129.5a1b8921.js"><link rel="prefetch" href="/assets/js/13.00771e07.js"><link rel="prefetch" href="/assets/js/130.3fc6ac18.js"><link rel="prefetch" href="/assets/js/131.6f4d6fd1.js"><link rel="prefetch" href="/assets/js/132.acdc1129.js"><link rel="prefetch" href="/assets/js/133.a3f54cd0.js"><link rel="prefetch" href="/assets/js/134.119c2728.js"><link rel="prefetch" href="/assets/js/135.9f6c57f3.js"><link rel="prefetch" href="/assets/js/136.ac7dd858.js"><link rel="prefetch" href="/assets/js/137.9afb710a.js"><link rel="prefetch" href="/assets/js/14.469caac5.js"><link rel="prefetch" href="/assets/js/15.9cb4518c.js"><link rel="prefetch" href="/assets/js/16.eb52a98b.js"><link rel="prefetch" href="/assets/js/17.fd207c74.js"><link rel="prefetch" href="/assets/js/18.9ac8edf4.js"><link rel="prefetch" href="/assets/js/19.7fd9cce0.js"><link rel="prefetch" href="/assets/js/20.3ac6699b.js"><link rel="prefetch" href="/assets/js/21.9bd21d49.js"><link rel="prefetch" href="/assets/js/22.26135513.js"><link rel="prefetch" href="/assets/js/23.12ca47ae.js"><link rel="prefetch" href="/assets/js/24.07c26276.js"><link rel="prefetch" href="/assets/js/25.1fb4186a.js"><link rel="prefetch" href="/assets/js/26.c0b427e0.js"><link rel="prefetch" href="/assets/js/27.a4c80d07.js"><link rel="prefetch" href="/assets/js/28.32d98e1e.js"><link rel="prefetch" href="/assets/js/29.3c8c6d0a.js"><link rel="prefetch" href="/assets/js/30.bedbe07f.js"><link rel="prefetch" href="/assets/js/31.01411239.js"><link rel="prefetch" href="/assets/js/32.ea727ff0.js"><link rel="prefetch" href="/assets/js/33.87e3a077.js"><link rel="prefetch" href="/assets/js/34.76c8aca7.js"><link rel="prefetch" href="/assets/js/36.845ccc35.js"><link rel="prefetch" href="/assets/js/37.66285bdf.js"><link rel="prefetch" href="/assets/js/38.cd20e592.js"><link rel="prefetch" href="/assets/js/39.b1b64548.js"><link rel="prefetch" href="/assets/js/4.da5852d0.js"><link rel="prefetch" href="/assets/js/40.32bbdbca.js"><link rel="prefetch" href="/assets/js/41.0d53a13c.js"><link rel="prefetch" href="/assets/js/42.9d946ef7.js"><link rel="prefetch" href="/assets/js/43.611048bf.js"><link rel="prefetch" href="/assets/js/44.adc1e594.js"><link rel="prefetch" href="/assets/js/45.54a35f8b.js"><link rel="prefetch" href="/assets/js/46.df5202cc.js"><link rel="prefetch" href="/assets/js/47.ba4c91a1.js"><link rel="prefetch" href="/assets/js/48.ad895aa9.js"><link rel="prefetch" href="/assets/js/49.f968d914.js"><link rel="prefetch" href="/assets/js/5.a9148791.js"><link rel="prefetch" href="/assets/js/50.5a347983.js"><link rel="prefetch" href="/assets/js/51.dba56927.js"><link rel="prefetch" href="/assets/js/52.9f01b6c1.js"><link rel="prefetch" href="/assets/js/53.cfa95d58.js"><link rel="prefetch" href="/assets/js/54.4e7ad936.js"><link rel="prefetch" href="/assets/js/55.2f053dbe.js"><link rel="prefetch" href="/assets/js/56.f8e4f338.js"><link rel="prefetch" href="/assets/js/57.8c30d45b.js"><link rel="prefetch" href="/assets/js/58.4a810bd8.js"><link rel="prefetch" href="/assets/js/59.bde195e5.js"><link rel="prefetch" href="/assets/js/6.f03db119.js"><link rel="prefetch" href="/assets/js/60.e9be82f8.js"><link rel="prefetch" href="/assets/js/61.13406dc4.js"><link rel="prefetch" href="/assets/js/62.672f6c8a.js"><link rel="prefetch" href="/assets/js/63.5ded7553.js"><link rel="prefetch" href="/assets/js/64.6b7f090e.js"><link rel="prefetch" href="/assets/js/65.bcda81a0.js"><link rel="prefetch" href="/assets/js/66.0b93a1c7.js"><link rel="prefetch" href="/assets/js/67.c584467f.js"><link rel="prefetch" href="/assets/js/68.5d410b3b.js"><link rel="prefetch" href="/assets/js/69.e6964620.js"><link rel="prefetch" href="/assets/js/7.0285f972.js"><link rel="prefetch" href="/assets/js/70.2ac6e3e7.js"><link rel="prefetch" href="/assets/js/71.76290ed4.js"><link rel="prefetch" href="/assets/js/72.0338d739.js"><link rel="prefetch" href="/assets/js/73.10458f48.js"><link rel="prefetch" href="/assets/js/74.eb0146bd.js"><link rel="prefetch" href="/assets/js/75.f7e34977.js"><link rel="prefetch" href="/assets/js/76.321dfdeb.js"><link rel="prefetch" href="/assets/js/77.19009647.js"><link rel="prefetch" href="/assets/js/78.a244a0af.js"><link rel="prefetch" href="/assets/js/79.504de44a.js"><link rel="prefetch" href="/assets/js/8.16c0171d.js"><link rel="prefetch" href="/assets/js/80.bfaf64db.js"><link rel="prefetch" href="/assets/js/81.57121759.js"><link rel="prefetch" href="/assets/js/82.60fe79be.js"><link rel="prefetch" href="/assets/js/83.65bd8161.js"><link rel="prefetch" href="/assets/js/84.a80c2a84.js"><link rel="prefetch" href="/assets/js/85.7fd8dffd.js"><link rel="prefetch" href="/assets/js/86.7fdcf982.js"><link rel="prefetch" href="/assets/js/87.2e61ea62.js"><link rel="prefetch" href="/assets/js/88.96ae1006.js"><link rel="prefetch" href="/assets/js/89.6ea5f56c.js"><link rel="prefetch" href="/assets/js/9.3daa8733.js"><link rel="prefetch" href="/assets/js/90.ffb91ca4.js"><link rel="prefetch" href="/assets/js/91.650af2b8.js"><link rel="prefetch" href="/assets/js/92.4fb6096a.js"><link rel="prefetch" href="/assets/js/93.ebd206ec.js"><link rel="prefetch" href="/assets/js/94.136dbf66.js"><link rel="prefetch" href="/assets/js/95.b8f07d6b.js"><link rel="prefetch" href="/assets/js/96.be7d3c6e.js"><link rel="prefetch" href="/assets/js/97.b07f412c.js"><link rel="prefetch" href="/assets/js/98.341cdd7c.js"><link rel="prefetch" href="/assets/js/99.c619520d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ad025e7c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-dad8a512><div data-v-dad8a512><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-dad8a512 data-v-dad8a512><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-dad8a512 data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>Substrate Recipes</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><!---->
            
          <!---->
          2020
        </a></span></div></div> <div class="hide" data-v-dad8a512><header class="navbar" data-v-dad8a512><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Substrate Recipes</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      Languages
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/3-entrees/fixed-point.html" aria-current="page" class="nav-link router-link-exact-active router-link-active"><i class="iconfont undefined"></i>
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/3-entrees/fixed-point.html" class="nav-link"><i class="iconfont undefined"></i>
  简体中文
</a></li></ul></div></div> <a href="https://github.com/tianxiemaochiyu/the_book_of_substrate_zh_CN" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask" data-v-dad8a512></div> <aside class="sidebar" data-v-dad8a512><div class="personal-info-wrapper" data-v-ca798c94 data-v-dad8a512><!----> <!----> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>0</h3> <h6 data-v-ca798c94>Article</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>0</h3> <h6 data-v-ca798c94>Tag</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      Languages
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/3-entrees/fixed-point.html" aria-current="page" class="nav-link router-link-exact-active router-link-active"><i class="iconfont undefined"></i>
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/3-entrees/fixed-point.html" class="nav-link"><i class="iconfont undefined"></i>
  简体中文
</a></li></ul></div></div> <a href="https://github.com/tianxiemaochiyu/the_book_of_substrate_zh_CN" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/" class="sidebar-heading clickable router-link-active open"><span>Substrate</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Introduction.html" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/1-prepare-kitchen/index" class="sidebar-heading clickable"><span>1. Preparing Your Kitchen</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/1-prepare-kitchen/1-build-node.html" class="sidebar-link">1.1. Building A Node</a></li><li><a href="/1-prepare-kitchen/2-interact-node.html" class="sidebar-link">1.2. Interacting with a Node</a></li><li><a href="/1-prepare-kitchen/3-kitchen-organization.html" class="sidebar-link">1.3. Kitchen Organization</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/2-appetizers/index" class="sidebar-heading clickable"><span>2. Appetizers</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/2-appetizers/1-hello-substrate.html" class="sidebar-link">2.1. Hello Substrate</a></li><li><a href="/2-appetizers/2-storage-values.html" class="sidebar-link">2.2. Single Value Storage</a></li><li><a href="/2-appetizers/3-errors.html" class="sidebar-link">2.3. Handling Errors</a></li><li><a href="/2-appetizers/4-events.html" class="sidebar-link">2.4. Events Verify Execution</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/3-entrees/index" class="sidebar-heading clickable open"><span>3. Entrees</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><a href="/3-entrees/storage-api/index" class="sidebar-heading clickable open"><span>3.1. Runtime Storage API</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/3-entrees/storage-api/storage-maps.html" class="sidebar-link">3.1.1. Runtime Storage API</a></li><li><a href="/3-entrees/storage-api/cache.html" class="sidebar-link">3.1.2. Cache Locally &gt; Storage Calls</a></li><li><a href="/3-entrees/storage-api/vec-set.html" class="sidebar-link">3.1.3. Using Vectors as Sets</a></li><li><a href="/3-entrees/storage-api/map-set.html" class="sidebar-link">3.1.4. Using Maps as Sets</a></li><li><a href="/3-entrees/storage-api/double.html" class="sidebar-link">3.1.5. Subgroup Removal by Subkey: Double Maps</a></li><li><a href="/3-entrees/storage-api/structs.html" class="sidebar-link">3.1.6. Storing custom structs</a></li><li><a href="/3-entrees/storage-api/ringbuffer.html" class="sidebar-link">3.1.7. Ringbuffer Queue</a></li></ul></section></li><li><a href="/3-entrees/basic-token.html" class="sidebar-link">3.2. Basic Token</a></li><li><a href="/3-entrees/constants.html" class="sidebar-link">3.3. Configurable Constants</a></li><li><a href="/3-entrees/crowdfund.html" class="sidebar-link">3.4. Simple Crowdfund</a></li><li><a href="/3-entrees/instantiable.html" class="sidebar-link">3.5. Instantiable Pallets</a></li><li><a href="/3-entrees/weights.html" class="sidebar-link">3.6. Weights for Resource Accounting</a></li><li><a href="/3-entrees/fees.html" class="sidebar-link">3.7. Transaction Fees for Economic Security</a></li><li><a href="/3-entrees/charity.html" class="sidebar-link">3.8. Charity and Imbalances</a></li><li><a href="/3-entrees/fixed-point.html" aria-current="page" class="active sidebar-link">3.9. Fixed Point Arithmetic</a></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/3-entrees/off-chain-workers/index" class="sidebar-heading clickable"><span>3.10. Off-chain Workers</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/3-entrees/off-chain-workers/transactions.html" class="sidebar-link">3.10.1. Transactions</a></li><li><a href="/3-entrees/off-chain-workers/http-json.html" class="sidebar-link">3.10.2. HTTP Fetching &amp; JSON Parsing</a></li><li><a href="/3-entrees/off-chain-workers/storage.html" class="sidebar-link">3.10.3. Local Storage</a></li></ul></section></li><li><a href="/3-entrees/runtime-api.html" class="sidebar-link">3.11. Runtime APIs</a></li><li><a href="/3-entrees/custom-rpc.html" class="sidebar-link">3.12. Custom RPCs</a></li><li><a href="/3-entrees/sha3-pow-consensus.html" class="sidebar-link">3.13. Sha3 Pow Consensus Algorithms</a></li><li><a href="/3-entrees/basic-pow.html" class="sidebar-link">3.14. Basic Proof of Work Node</a></li><li><a href="/3-entrees/hybrid-consensus.html" class="sidebar-link">3.15. Hybrid PoW/PoS Consensus Node</a></li><li><a href="/3-entrees/manual-seal.html" class="sidebar-link">3.16. Manual Seal Consensus</a></li><li><a href="/3-entrees/kitchen-node.html" class="sidebar-link">3.17. Kitchen Node - An reusable instant seal node</a></li><li><a href="/3-entrees/babe-grandpa-node.html" class="sidebar-link">3.18. Babe and Grandpa Node</a></li><li><a href="/3-entrees/currency.html" class="sidebar-link">3.19. Currency Types</a></li><li><a href="/3-entrees/randomness.html" class="sidebar-link">3.20. Generating Randomness</a></li><li><a href="/3-entrees/execution-schedule.html" class="sidebar-link">3.21. Execution Schedule</a></li><li><a href="/3-entrees/pallet-coupling.html" class="sidebar-link">3.22. Tightly- and Loosely-Coupled Pallets</a></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/3-entrees/testing/index" class="sidebar-heading clickable"><span>3.23. Testing</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/3-entrees/testing/mock.html" class="sidebar-link">3.23.1. Basic Test Environments</a></li><li><a href="/3-entrees/testing/common.html" class="sidebar-link">3.23.2. Common Testsg</a></li><li><a href="/3-entrees/testing/off-chain-workers.html" class="sidebar-link">3.23.3. Off-chain Worker Test Environment</a></li><li><a href="/3-entrees/testing/externalities.html" class="sidebar-link">3.23.4. Custom Test Environment</a></li></ul></section></li><li><a href="/3-entrees/safemath.html" class="sidebar-link">3.24. Safe Math</a></li></ul></section></li><li><a href="/more-resources.html" class="sidebar-link">4. More Resources</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e></h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><!---->
            
          <!---->
          2020
        </a></span></div></div> <div data-v-dad8a512><main class="page"><div class="page-title" style="display:none;"><h1>Fixed Point Arithmetic</h1> <div data-v-3b7f5bdf><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default" style="display:none;"><h1 id="fixed-point-arithmetic"><a href="#fixed-point-arithmetic" class="header-anchor">#</a> Fixed Point Arithmetic</h1> <p><code>pallets/fixed-point</code> <a href="https://playground-staging.substrate.dev/?deploy=recipes&amp;files=%2Fhome%2Fsubstrate%2Fworkspace%2Fpallets%2Ffixed-point%2Fsrc%2Flib.rs" target="_blank" rel="noopener noreferrer"><img src="https://img.shields.io/badge/Playground-Try%20it!-brightgreen?logo=Parity%20Substrate" alt="Try on playground"> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/fixed-point/src/lib.rs" target="_blank" rel="noopener noreferrer"><img src="https://img.shields.io/badge/Github-View%20Code-brightgreen?logo=github" alt="View on GitHub"> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><code>pallets/compounding-interest</code> <a href="https://playground-staging.substrate.dev/?deploy=recipes&amp;files=%2Fhome%2Fsubstrate%2Fworkspace%2Fpallets%2Fcompounding-interest%2Fsrc%2Flib.rs" target="_blank" rel="noopener noreferrer"><img src="https://img.shields.io/badge/Playground-Try%20it!-brightgreen?logo=Parity%20Substrate" alt="Try on playground"> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/compounding-interest/src/lib.rs" target="_blank" rel="noopener noreferrer"><img src="https://img.shields.io/badge/Github-View%20Code-brightgreen?logo=github" alt="View on GitHub"> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>When programmers learn to use non-integer numbers in their programs, they are usually taught to use
<a href="https://en.wikipedia.org/wiki/Floating-point_arithmetic" target="_blank" rel="noopener noreferrer">floating point<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s. In blockchain, we use an
alternative representation of fractional numbers called
<a href="https://en.wikipedia.org/wiki/Fixed-point_arithmetic" target="_blank" rel="noopener noreferrer">fixed point<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. There are several ways to use
fixed point numbers, and this recipe will introduce three of them. In particular we'll see:</p> <ul><li>Substrate's own fixed point structs and traits</li> <li>The <a href="https://github.com/encointer/substrate-fixed/" target="_blank" rel="noopener noreferrer">substrate-fixed<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> library</li> <li>A manual fixed point implementation (and why it's nicer to use a library)</li> <li>A comparison of the two libraries in a compounding interest example</li></ul> <h2 id="what-s-wrong-with-floats"><a href="#what-s-wrong-with-floats" class="header-anchor">#</a> What's Wrong with Floats?</h2> <p>Floats are cool for all kinds of reasons, but they also have one important drawback. Floating point
arithmetic is <strong>nondeterministic</strong> which means that different processors compute (slightly)
different results for the same operation. Although there is an
<a href="https://en.wikipedia.org/wiki/IEEE_754" target="_blank" rel="noopener noreferrer">IEEE spec<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, nondeterminism can come from specific libraries
used, or even hardware. In order for the nodes in a blockchain network to reach agreement on the
state of the chain, all operations must be completely deterministic. Luckily fixed point arithmetic
is deterministic, and is often not much harder to use once you get the hang of it.</p> <h2 id="multiplicative-accumulators"><a href="#multiplicative-accumulators" class="header-anchor">#</a> Multiplicative Accumulators</h2> <p><em><a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/fixed-point" target="_blank" rel="noopener noreferrer"><code>pallets/fixed-point</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em></p> <p>The first pallet covered in this recipe contains three implementations of a multiplicative
accumulator. That's a fancy way to say the pallet lets users submit fractional numbers and keeps
track of the product from multiplying them all together. The value starts out at one (the
<a href="https://en.wikipedia.org/wiki/Identity_element" target="_blank" rel="noopener noreferrer">multiplicative identity<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>), and it gets multiplied
by whatever values the users submit. These three independent implementations compare and contrast
the features of each.</p> <h3 id="permill-accumulator"><a href="#permill-accumulator" class="header-anchor">#</a> Permill Accumulator</h3> <p>We'll be using the most common approach which takes its fixed point implementation from Substrate
itself. There are a few fixed-point structs available in Substrate, all of which implement the
<a href="https://substrate.dev/rustdocs/v2.0.0-rc4/sp_arithmetic/trait.PerThing.html" target="_blank" rel="noopener noreferrer"><code>PerThing</code> trait<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, that cover different
amounts of precision. For this accumulator example, we'll use the
<a href="https://substrate.dev/rustdocs/v2.0.0-rc4/sp_arithmetic/struct.Permill.html" target="_blank" rel="noopener noreferrer"><code>PerMill</code> struct<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> which represents
fractions as parts per million. There are also
<a href="https://substrate.dev/rustdocs/v2.0.0-rc4/sp_arithmetic/struct.Perbill.html" target="_blank" rel="noopener noreferrer"><code>Perbill</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,
<a href="https://substrate.dev/rustdocs/v2.0.0-rc4/sp_arithmetic/struct.Percent.html" target="_blank" rel="noopener noreferrer"><code>PerCent</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, and
<a href="https://substrate.dev/rustdocs/v2.0.0-rc4/sp_arithmetic/struct.PerU16.html" target="_blank" rel="noopener noreferrer"><code>PerU16</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, which all provide the same
interface (because it comes from the trait). Substrate's fixed-point structs are somewhat unique
because they represent <em>only</em> fractional parts of numbers. That means they can represent numbers
between 0 and 1 inclusive, but <em>not</em> numbers with whole parts like 2.718 or 3.14.</p> <p>To begin we declare the storage item that will hold our accumulated product. You can see that the
trait provides a handy function for getting the identity value which we use to set the default
storage value to <code>1</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token macro property">decl_storage!</span> <span class="token punctuation">{</span>
	<span class="token keyword">trait</span> <span class="token class-name">Store</span> <span class="token keyword">for</span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">&gt;</span> <span class="token keyword">as</span> <span class="token class-name">Example</span> <span class="token punctuation">{</span>
		<span class="token comment">// --snip--</span>

		<span class="token comment">/// Permill accumulator, value starts at 1 (multiplicative identity)</span>
		<span class="token class-name">PermillAccumulator</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token function-definition function">permill_value</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">Permill</span> <span class="token operator">=</span> <span class="token class-name">Permill</span><span class="token punctuation">::</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The only extrinsic for this Permill accumulator is the one that allows users to submit new <code>Permill</code>
values to get multiplied into the accumulator.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">update_permill</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> new_factor<span class="token punctuation">:</span> <span class="token class-name">Permill</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">DispatchResult</span> <span class="token punctuation">{</span>
	<span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

	<span class="token keyword">let</span> old_accumulated <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">permill_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// There is no need to check for overflow here. Permill holds values in the range</span>
	<span class="token comment">// [0, 1] so it is impossible to ever overflow.</span>
	<span class="token keyword">let</span> new_product <span class="token operator">=</span> old_accumulated<span class="token punctuation">.</span><span class="token function">saturating_mul</span><span class="token punctuation">(</span>new_factor<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Write the new value to storage</span>
	<span class="token class-name">PermillAccumulator</span><span class="token punctuation">::</span><span class="token function">put</span><span class="token punctuation">(</span>new_product<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Emit event</span>
	<span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">PermillUpdated</span><span class="token punctuation">(</span>new_factor<span class="token punctuation">,</span> new_product<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The code of this extrinsic largely speaks for itself. One thing to take particular note of is that
we <em>don't</em> check for overflow on the multiplication. If you've read many of the recipes you know
that a Substrate runtime must never panic, and a developer must be extremely diligent in always
checking for and gracefully handling error conditions. Because <code>Permill</code> only holds values between 0
and 1, we know that their product will always be in that same range. Thus it is impossible to
overflow or saturate. So we can happily use <code>saturating_mul</code> and move on.</p> <h3 id="substrate-fixed-accumulator"><a href="#substrate-fixed-accumulator" class="header-anchor">#</a> Substrate-fixed Accumulator</h3> <p><a href="https://github.com/encointer/substrate-fixed/" target="_blank" rel="noopener noreferrer">Substrate-fixed<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> takes a more traditional approach
in that their types represent numbers with both whole <em>and</em> fractional parts. For this
implementation, we'll use the <code>U16F16</code> type. This type contains an unsigned number (indicated by the
<code>U</code> at the beginning) and has 32 <em>total</em> bits of precision - 16 for the integer part, and 16 for the
fractional part. There are several other types provided that follow the same naming convention. Some
examples include <code>U32F32</code> and <code>I32F32</code> where the <code>I</code> indicates a signed number, just like in Rust
primitive types.</p> <p>As in the <code>Permill</code> example, we begin by declaring the storage item. With substrate-fixed, there is
not a <code>one</code> function, but there is a <code>from_num</code> function that we use to set the storage item's
default value. This <code>from_num</code> method and its counterpart <code>to-num</code> are your primary ways of
converting between substrate-fixed types and Rust primitive types. If your use case does a lot of
fixed-point arithmetic, like ours does, it is advisable to keep your data in substrate-fixed types.</p> <blockquote><p>We're able to use <code>U16F16</code> as a storage item type because it, and the other substrate-fixed types,
implements the parity scale codec.</p></blockquote> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token macro property">decl_storage!</span> <span class="token punctuation">{</span>
	<span class="token keyword">trait</span> <span class="token class-name">Store</span> <span class="token keyword">for</span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">&gt;</span> <span class="token keyword">as</span> <span class="token class-name">Example</span> <span class="token punctuation">{</span>
		<span class="token comment">// --snip--</span>

		<span class="token comment">/// Substrate-fixed accumulator, value starts at 1 (multiplicative identity)</span>
		<span class="token class-name">FixedAccumulator</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token function-definition function">fixed_value</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">U16F16</span> <span class="token operator">=</span> <span class="token constant">U16F16</span><span class="token punctuation">::</span><span class="token function">from_num</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Next we implement the extrinsic that allows users to update the accumulator by multiplying in a new
value.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">update_fixed</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> new_factor<span class="token punctuation">:</span> <span class="token constant">U16F16</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">DispatchResult</span> <span class="token punctuation">{</span>
	<span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

	<span class="token keyword">let</span> old_accumulated <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">fixed_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Multiply, handling overflow</span>
	<span class="token keyword">let</span> new_product <span class="token operator">=</span> old_accumulated<span class="token punctuation">.</span><span class="token function">checked_mul</span><span class="token punctuation">(</span>new_factor<span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">ok_or</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token class-name">Overflow</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

	<span class="token comment">// Write the new value to storage</span>
	<span class="token class-name">FixedAccumulator</span><span class="token punctuation">::</span><span class="token function">put</span><span class="token punctuation">(</span>new_product<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Emit event</span>
	<span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">FixedUpdated</span><span class="token punctuation">(</span>new_factor<span class="token punctuation">,</span> new_product<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This extrinsic is quite similar to the <code>Permill</code> version with one notable difference. Because
<code>U16F16</code> handles numbers greater than one, overflow is possible, and we need to handle it. The error
handling here is straightforward, the important part is just that you remember to do it.</p> <p>This example has shown the fundamentals of substrate-fixed, but this library has much more to offer
as we'll see in the compounding interest example.</p> <h3 id="manual-accumulator"><a href="#manual-accumulator" class="header-anchor">#</a> Manual Accumulator</h3> <p>In this final accumulator implementation, we manually track fixed point numbers using Rust's native
<code>u32</code> as the underlying data type. This example is educational, but is only practical in the
simplest scenarios. Generally you will have a <s>more fun</s> less error-prone time coding if you use
one of the previous two fixed-point types in your real-world applications.</p> <p>Fixed point is not very complex conceptually. We represent fractional numbers as regular old
integers, and we decide in advance to consider some of the place values fractional. It's just like
saying we'll omit the decimal point when talking about money and all agree that &quot;1995&quot; actually
<em>means</em> 19.95 €. This is exactly how Substrate's
<a href="https://substrate.dev/rustdocs/v2.0.0-rc4/pallet_balances/index.html" target="_blank" rel="noopener noreferrer">Balances pallet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> works, a tradition that's
been in blockchain since Bitcon. In our example we will treat 16 bits as integer values, and 16 as
fractional, just as substrate-fixed's <code>U16F16</code> did.</p> <p>If you're rusty or unfamiliar with place values in the
<a href="https://en.wikipedia.org/wiki/Binary_number" target="_blank" rel="noopener noreferrer">binary number system<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, it may be useful to brush up.
(Or skip this detailed section and proceed to the compounding interest example.)</p> <div class="language- extra-class"><pre class="language-text"><code>Normal interpretation of u32 place values
... ___ ___ ___ ___ ___ ___ ___ .
...  64  32  16  8   4   2   1

Fixed interpretation of u32 place values
... ___ ___ ___ ___ . ___ ___ ___ ___ ...
...  8   4   2   1    1/2 1/4 1/8 1/16...
</code></pre></div><p>Although the concepts are straight-forward, you'll see that manually implementing operations like
multiplication is quite error prone. Therefore, when writing your own blockchain applications, it is
often best to use on of the provided libraries covered in the other two implementations of the
accumulator.</p> <p>As before, we begin by declaring the storage value. This time around it is just a simple u32. But
the default value, <code>1 &lt;&lt; 16</code> looks quite funny. If you haven't encountered it before <code>&lt;&lt;</code> is Rust's
<a href="https://doc.rust-lang.org/reference/expressions/operator-expr.html#arithmetic-and-logical-binary-operators" target="_blank" rel="noopener noreferrer">bit shift operator<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
It takes a value and moves all the bits to the left. In this case we start with the value <code>1</code> and
move it 16 bits to the left. This is because Rust interprets <code>1</code> as a regular <code>u32</code> value and puts
the <code>1</code> in the far right place value. But because we're treating this <code>u32</code> specially, we need to
shift that bit to the middle just left of the imaginary radix point.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token macro property">decl_storage!</span> <span class="token punctuation">{</span>
	<span class="token keyword">trait</span> <span class="token class-name">Store</span> <span class="token keyword">for</span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">&gt;</span> <span class="token keyword">as</span> <span class="token class-name">Example</span> <span class="token punctuation">{</span>
		<span class="token comment">// --snip--</span>

		<span class="token comment">/// Manual accumulator, value starts at 1 (multiplicative identity)</span>
		<span class="token class-name">ManualAccumulator</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token function-definition function">manual_value</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">u32</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The extrinsic to multiply a new factor into the accumulator follows the same general flow as in the
other two implementations. In this case, there are more intermediate values calculated, and more
comments explaining the bit-shifting operations. In the function body most intermediate values are
held in <code>u64</code> variables. This is because when you multiply two 32-bit numbers, you can end up with
as much as 64 bits in the product.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">update_manual</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> new_factor<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">DispatchResult</span> <span class="token punctuation">{</span>
	<span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

	<span class="token comment">// To ensure we don't overflow unnecessarily, the values are cast up to u64 before multiplying.</span>
	<span class="token comment">// This intermediate format has 48 integer positions and 16 fractional.</span>
	<span class="token keyword">let</span> old_accumulated <span class="token punctuation">:</span> <span class="token keyword">u64</span> <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">manual_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> new_factor_u64 <span class="token punctuation">:</span> <span class="token keyword">u64</span> <span class="token operator">=</span> new_factor <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">;</span>

	<span class="token comment">// Perform the multiplication on the u64 values</span>
	<span class="token comment">// This intermediate format has 32 integer positions and 32 fractional.</span>
	<span class="token keyword">let</span> raw_product <span class="token punctuation">:</span> <span class="token keyword">u64</span> <span class="token operator">=</span> old_accumulated <span class="token operator">*</span> new_factor_u64<span class="token punctuation">;</span>

	<span class="token comment">// Right shift to restore the convention that 16 bits are fractional.</span>
	<span class="token comment">// This is a lossy conversion.</span>
	<span class="token comment">// This intermediate format has 48 integer positions and 16 fractional.</span>
	<span class="token keyword">let</span> shifted_product <span class="token punctuation">:</span> <span class="token keyword">u64</span> <span class="token operator">=</span> raw_product <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">;</span>

	<span class="token comment">// Ensure that the product fits in the u32, and error if it doesn't</span>
	<span class="token keyword">if</span> shifted_product <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">::</span><span class="token function">max_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token class-name">Overflow</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Write the new value to storage</span>
	<span class="token class-name">ManualAccumulator</span><span class="token punctuation">::</span><span class="token function">put</span><span class="token punctuation">(</span>shifted_product <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Emit event</span>
	<span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">ManualUpdated</span><span class="token punctuation">(</span>new_factor<span class="token punctuation">,</span> shifted_product <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As mentioned above, when you multiply two 32-bit numbers, you can end up with as much as 64 bits in
the product. In this 64-bit intermediate product, we have 32 integer bits and 32 fractional. We can
simply throw away the 16 right-most fractional bits that merely provide extra precision. But we need
to be careful with the 16 left-most integer bits. If any of those bits are non-zero after the
multiplication it means overflow has occurred. If they are all zero, then we can safely throw them
away as well.</p> <blockquote><p>If this business about having more bits after the multiplication is confusing, try this exercise
in the more familiar decimal system. Consider these numbers that have 4 total digits (2 integer,
and two fractional): 12.34 and 56.78. Multiply them together. How many integer and fractional
digits are in the product? Try that again with larger numbers like 98.76 and 99.99, and smaller like
00.11 and 00.22. Which of these products can be fit back into a 4-digit number like the ones we
started with?</p></blockquote> <h2 id="compounding-interest"><a href="#compounding-interest" class="header-anchor">#</a> Compounding Interest</h2> <p><em><a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/compounding-interest" target="_blank" rel="noopener noreferrer"><code>pallets/compounding-interest</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em></p> <p>Many financial agreements involve interest for loaned or borrowed money.
<a href="https://en.wikipedia.org/wiki/Compound_interest" target="_blank" rel="noopener noreferrer">Compounding interest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is when new interest is paid
on top of not only the original loan amount, the so-called &quot;principal&quot;, but also any interest that
has been previously paid.</p> <h3 id="discrete-compounding"><a href="#discrete-compounding" class="header-anchor">#</a> Discrete Compounding</h3> <p>Our first example will look at discrete compounding interest. This is when interest is paid at a
fixed interval. In our case, interest will be paid every ten blocks.</p> <p>For this implementation we've chosen to use Substrate's
<a href="https://substrate.dev/rustdocs/v2.0.0-rc4/sp_arithmetic/struct.Percent.html" target="_blank" rel="noopener noreferrer"><code>Percent</code> type<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. It works nearly the
same as <code>Permill</code>, but it represents numbers as &quot;parts per hundred&quot; rather than &quot;parts per million&quot;.
We could also have used Substrate-fixed for this implementation, but chose to save it for the next
example.</p> <p>The only storage item needed is a tracker of the account's balance. In order to focus on the
fixed-point- and interest-related topics, this pallet does not actually interface with a <code>Currency</code>.
Instead we just allow anyone to &quot;deposit&quot; or &quot;withdraw&quot; funds with no source or destination.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token macro property">decl_storage!</span> <span class="token punctuation">{</span>
	<span class="token keyword">trait</span> <span class="token class-name">Store</span> <span class="token keyword">for</span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">&gt;</span> <span class="token keyword">as</span> <span class="token class-name">Example</span> <span class="token punctuation">{</span>
		<span class="token comment">// --snip--</span>

		<span class="token comment">/// Balance for the discrete interest account</span>
		<span class="token class-name">DiscreteAccount</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token function-definition function">discrete_account</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>There are two extrinsics associated with the discrete interest account. The <code>deposit_discrete</code>
extrinsic is shown here, and the <code>withdraw_discrete</code> extrinsic is nearly identical. Check it out in
the kitchen.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">deposit_discrete</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> val_to_add<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">DispatchResult</span> <span class="token punctuation">{</span>
	<span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

	<span class="token keyword">let</span> old_value <span class="token operator">=</span> <span class="token class-name">DiscreteAccount</span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Update storage for discrete account</span>
	<span class="token class-name">DiscreteAccount</span><span class="token punctuation">::</span><span class="token function">put</span><span class="token punctuation">(</span>old_value <span class="token operator">+</span> val_to_add<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Emit event</span>
	<span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">DepositedDiscrete</span><span class="token punctuation">(</span>val_to_add<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The flow of these deposit and withdraw extrinsics is entirely straight-forward. They each perform a
simple addition or substraction from the stored value, and they have nothing to do with interest.</p> <p>Because the interest is paid discretely every ten blocks it can be handled independently of deposits
and withdrawals. The interest calculation happens automatically in the <code>on_finalize</code> block.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">on_finalize</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Apply newly-accrued discrete interest every ten blocks</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// Calculate interest Interest = principal * rate * time</span>
		<span class="token comment">// We can use the `*` operator for multiplying a `Percent` by a u64</span>
		<span class="token comment">// because `Percent` implements the trait Mul&lt;u64&gt;</span>
		<span class="token keyword">let</span> interest <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">discrete_interest_rate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token class-name">DiscreteAccount</span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>

		<span class="token comment">// The following line, although similar, does not work because</span>
		<span class="token comment">// u64 does not implement the trait Mul&lt;Percent&gt;</span>
		<span class="token comment">// let interest = DiscreteAccount::get() * Self::discrete_interest_rate() * 10;</span>

		<span class="token comment">// Update the balance</span>
		<span class="token keyword">let</span> old_balance <span class="token operator">=</span> <span class="token class-name">DiscreteAccount</span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">DiscreteAccount</span><span class="token punctuation">::</span><span class="token function">put</span><span class="token punctuation">(</span>old_balance <span class="token operator">+</span> interest<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Emit the event</span>
		<span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">DiscreteInterestApplied</span><span class="token punctuation">(</span>interest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>on_finalize</code> is called at the end of every block, but we only want to pay interest every ten
blocks, so the first thing we do is check whether this block is a multiple of ten. If it is we
calculate the interest due by the formula <code>interest = principal * rate * time</code>. As the comments
explain, there is some subtlety in the order of the multiplication. You can multiply <code>PerCent * u64</code>
but not <code>u64 * PerCent</code>.</p> <h3 id="continuously-compounding"><a href="#continuously-compounding" class="header-anchor">#</a> Continuously Compounding</h3> <p>You can imagine increasing the frequency at which the interest is paid out. Increasing the frequency
enough approaches
<a href="https://en.wikipedia.org/wiki/Compound_interest#Continuous_compounding" target="_blank" rel="noopener noreferrer">continuously compounding interest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
Calculating continuously compounding interest requires the
<a href="https://en.wikipedia.org/wiki/Exponential_function" target="_blank" rel="noopener noreferrer">exponential function<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> which is not available
using Substrate's <code>PerThing</code> types. Luckily exponential and other
<a href="https://en.wikipedia.org/wiki/Transcendental_function" target="_blank" rel="noopener noreferrer">transcendental functions<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> are available in
substrate-fixed, which is why we've chosen to use it for this example.</p> <p>With continuously compounded interest, we <em>could</em> update the interest in <code>on_finalize</code> as we did
before, but it would need to be updated every single block. Instead we wait until a user tries to
use the account (to deposit or withdraw funds), and then calculate the account's current value &quot;just
in time&quot;.</p> <p>To facilitate this implementation, we represent the state of the account not only as a balance, but
as a balance, paired with the time when that balance was last updated.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Encode, Decode, Default)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ContinuousAccountData</span><span class="token operator">&lt;</span><span class="token class-name">BlockNumber</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">/// The balance of the account after last manual adjustment</span>
	principal<span class="token punctuation">:</span> <span class="token constant">I32F32</span><span class="token punctuation">,</span>
	<span class="token comment">/// The time (block height) at which the balance was last adjusted</span>
	deposit_date<span class="token punctuation">:</span> <span class="token class-name">BlockNumber</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You can see we've chosen substrate-fixed's <code>I32F32</code> as our balance type this time. While we don't
intend to handle negative balances, there is currently a limitation in the transcendental functions
that requires using signed types.</p> <p>With the struct to represent the account's state defined, we can initialize the storage value.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token macro property">decl_storage!</span> <span class="token punctuation">{</span>
	<span class="token keyword">trait</span> <span class="token class-name">Store</span> <span class="token keyword">for</span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">&gt;</span> <span class="token keyword">as</span> <span class="token class-name">Example</span> <span class="token punctuation">{</span>
		<span class="token comment">// --snip--</span>

		<span class="token comment">/// Balance for the continuously compounded account</span>
		<span class="token class-name">ContinuousAccount</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token function-definition function">balance_compound</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">ContinuousAccountData</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As before, there are two relevant extrinsics, <code>deposit_continuous</code> and <code>withdraw_continuous</code>. They
are nearly identical so we'll only show one.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">deposit_continuous</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> val_to_add<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">DispatchResult</span> <span class="token punctuation">{</span>
	<span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

	<span class="token keyword">let</span> current_block <span class="token operator">=</span> <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">Module</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token function">block_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> old_value <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">value_of_continuous_account</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>current_block<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Update storage for compounding account</span>
	<span class="token class-name">ContinuousAccount</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token function">put</span><span class="token punctuation">(</span>
		<span class="token class-name">ContinuousAccountData</span> <span class="token punctuation">{</span>
			principal<span class="token punctuation">:</span> old_value <span class="token operator">+</span> <span class="token constant">I32F32</span><span class="token punctuation">::</span><span class="token function">from_num</span><span class="token punctuation">(</span>val_to_add<span class="token punctuation">)</span><span class="token punctuation">,</span>
			deposit_date<span class="token punctuation">:</span> current_block<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Emit event</span>
	<span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">DepositedContinuous</span><span class="token punctuation">(</span>val_to_add<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This function itself isn't too insightful. It does the same basic things as the discrete variant:
look up the old value and the deposit, update storage, and emit an event. The one interesting part
is that it calls a helper function to get the account's previous value. This helper function
calculates the value of the account considering all the interest that has accrued since the last
time the account was touched. Let's take a closer look.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">value_of_continuous_account</span><span class="token punctuation">(</span>now<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token operator">&lt;</span><span class="token class-name">T</span> <span class="token keyword">as</span> <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">Trait</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token constant">I32F32</span> <span class="token punctuation">{</span>
	<span class="token comment">// Get the old state of the accout</span>
	<span class="token keyword">let</span> <span class="token class-name">ContinuousAccountData</span><span class="token punctuation">{</span>
		principal<span class="token punctuation">,</span>
		deposit_date<span class="token punctuation">,</span>
	<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token class-name">ContinuousAccount</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Calculate the exponential function (lots of type conversion)</span>
	<span class="token keyword">let</span> elapsed_time_block_number <span class="token operator">=</span> <span class="token operator">*</span>now <span class="token operator">-</span> deposit_date<span class="token punctuation">;</span>
	<span class="token keyword">let</span> elapsed_time_u32 <span class="token operator">=</span> <span class="token class-name">TryInto</span><span class="token punctuation">::</span><span class="token function">try_into</span><span class="token punctuation">(</span>elapsed_time_block_number<span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;blockchain will not exceed 2^32 blocks; qed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> elapsed_time_i32f32 <span class="token operator">=</span> <span class="token constant">I32F32</span><span class="token punctuation">::</span><span class="token function">from_num</span><span class="token punctuation">(</span>elapsed_time_u32<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> exponent <span class="token punctuation">:</span> <span class="token constant">I32F32</span> <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">continuous_interest_rate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> elapsed_time_i32f32<span class="token punctuation">;</span>
	<span class="token keyword">let</span> exp_result <span class="token punctuation">:</span> <span class="token constant">I32F32</span> <span class="token operator">=</span> <span class="token function">exp</span><span class="token punctuation">(</span>exponent<span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Interest will not overflow account (at least not until the learner has learned enough about fixed point :)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Return the result interest = principal * e ^ (rate * time)</span>
	principal <span class="token operator">*</span> exp_result
<span class="token punctuation">}</span>
</code></pre></div><p>This function gets the previous state of the account, makes the interest calculation and returns the
result. The reality of making these fixed point calculations is that type conversion will likely be
your biggest pain point. Most of the lines are doing type conversion between the <code>BlockNumber</code>,
<code>u32</code>, and <code>I32F32</code> types.</p> <p>We've already seen that this helper function is used within the runtime for calculating the current
balance &quot;just in time&quot; to make adjustments. In a real-world scenario, chain users would also want to
check their balance at any given time. Because the current balance is not stored in runtime storage,
it would be wise to <a href="/3-entrees/runtime-api.html">implement a runtime API</a> so this helper can be called from
outside the runtime.</p></div> <footer class="page-edit" style="display:none;"><div class="edit-link"><a href="https://github.com/tianxiemaochiyu/the_book_of_substrate_zh_CN/edit/master/docs/3-entrees/fixed-point.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.a10ecbc3.js" defer></script><script src="/assets/js/3.911ff76f.js" defer></script><script src="/assets/js/1.8aeda072.js" defer></script><script src="/assets/js/35.98662951.js" defer></script>
  </body>
</html>
